#!/usr/bin/env zsh
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# NEXUSPRO AI STUDIO v50.0 - PRODUCTION CONFIGURATION
# MILITARY-GRADE ENTERPRISE ZSH SETUP
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# โ  โโโโโโโ  โโโโโโโ โโโโ   โโโโโโโโโโโโโโโโโโ โโโโโโโโ โโโโโโ โโโ            โ
# โ  โโโโโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ            โ
# โ  โโโ  โโโโโโ   โโโโโโโโโ โโโโโโโโโ  โโโ  โโโโโโโโโ  โโโโโโโโโโโ            โ
# โ  โโโ  โโโโโโ   โโโโโโโโโโโโโโโโโโโ  โโโ  โโโโโโโโโ  โโโโโโโโโโโ            โ
# โ  โโโโโโโโโโโโโโโโโโโโ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโ       โ
# โ  โโโโโโโ  โโโโโโโ โโโ  โโโโโโโโโโโโโโโโโโโโ โโโโโโโโโโโ  โโโโโโโโโโโ       โ
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

set -euo pipefail
emulate -L zsh

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# SECTION 0: INSTANT PROMPT FIX - MUST BE FIRST
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

typeset -g POWERLEVEL9K_INSTANT_PROMPT=quiet

if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# SECTION 1: CRITICAL PATH FIXES (Per brew doctor)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

# ๐จ FIX #1: Proper PATH order - /usr/local/bin BEFORE /usr/bin
export PATH="/usr/local/bin:/usr/local/sbin:/usr/bin:/usr/sbin:/bin:/sbin"

# Add user local paths
export PATH="$HOME/.local/bin:$HOME/bin:$PATH"

# Add optional development paths
[[ -d "$HOME/.cargo/bin" ]] && export PATH="$HOME/.cargo/bin:$PATH"
[[ -d "$HOME/go/bin" ]] && export PATH="$HOME/go/bin:$PATH"
[[ -d "$HOME/.nvm/bin" ]] && export PATH="$HOME/.nvm/bin:$PATH"
[[ -d "/opt/homebrew/bin" ]] && export PATH="/opt/homebrew/bin:$PATH"

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# SECTION 2: SYSTEM ENVIRONMENT
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8
export EDITOR=nano
export VISUAL=nano
export PAGER=less

# ZSH specific options
setopt HIST_FIND_NO_DUPS
setopt HIST_IGNORE_DUPS
setopt SHARE_HISTORY
setopt INC_APPEND_HISTORY
setopt NO_HUP

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# SECTION 3: OH-MY-ZSH INITIALIZATION
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

export ZSH="$HOME/.oh-my-zsh"
ZSH_THEME="powerlevel10k/powerlevel10k"

# OMZ Configuration
DISABLE_AUTO_UPDATE=true
COMPLETION_WAITING_DOTS=true
DISABLE_UNTRACKED_FILES_DIRTY=true
HYPHEN_INSENSITIVE=true

# ๐ซ FIXED: Removed broken/missing plugins
# Previously caused errors: docker, docker-compose, kubectl, azure-cli, etc.
plugins=(
    # โ Core verified plugins
    git
    macos
    brew
    sudo
    copyfile
    copypath
    dirhistory
    history
    web-search
    colored-man-pages
    extract
    command-not-found
    common-aliases
    
    # โ Development plugins
    python
    pip
    node
    npm
    ruby
)

source $ZSH/oh-my-zsh.sh

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# SECTION 4: PRODUCTION HEADER ENGINE
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

nexus_header() {
    clear
    cat << 'EOF'
โญโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฎ
โ  โโโโโโโ  โโโโโโโ โโโโ   โโโโโโโโโโโโโโโโโโ โโโโโโโโ โโโโโโ โโโ      โ
โ  โโโโโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ      โ
โ  โโโ  โโโโโโ   โโโโโโโโโ โโโโโโโโโ  โโโ  โโโโโโโโโ  โโโโโโโโโโโ      โ
โ  โโโ  โโโโโโ   โโโโโโโโโโโโโโโโโโโ  โโโ  โโโโโโโโโ  โโโโโโโโโโโ      โ
โ  โโโโโโโโโโโโโโโโโโโโ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโ โ
โ  โโโโโโโ  โโโโโโโ โโโ  โโโโโโโโโโโโโโโโโโโโ โโโโโโโโโโโ  โโโโโโโโโโโ โ
โฐโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฏ
EOF

    printf "\n๐ NexusPro AI Studio v50.0\n"
    printf "๐ก Type 'nexus_dashboard' for control panel\n\n"
}

# Display header once on startup
if [[ -o interactive ]] && [[ -z "$NEXUS_STARTUP_DONE" ]]; then
    export NEXUS_STARTUP_DONE=1
    nexus_header
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# SECTION 5: PRODUCTION ALIASES (ERROR-FREE)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

# System commands
alias cls="clear && nexus_header"
alias ll="ls -la"
alias lt="ls -lart"
alias h="history | tail -30"
alias ip="curl -s ifconfig.me 2>/dev/null || echo 'offline'"

# Navigation
alias ..="cd .."
alias ...="cd ../.."
alias ~="cd ~"
alias desk="cd ~/Desktop"
alias proj="cd ~/Projects"

# Development
alias python="python3"
alias pip="pip3"
alias pyenv="python3 -m venv venv"
alias activate="source venv/bin/activate"

# Git
alias gs="git status"
alias ga="git add"
alias gc="git commit -m"
alias gpush="git push"
alias gpull="git pull"
alias glog="git log --oneline --graph --decorate -20"

# Npm
alias nr="npm run"
alias ni="npm install"
alias nig="npm install -g"

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# SECTION 6: CRITICAL FUNCTIONS
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

# ๐ฉบ System health check
system_health() {
    echo ""
    echo "๐ฉบ SYSTEM HEALTH CHECK"
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    
    # CPU
    top -l 1 | grep "CPU usage" | head -1
    
    # Memory
    vm_stat | grep "Pages free" | head -1
    
    # Disk
    df -h / | tail -1
    
    # Battery
    if pmset -g batt 2>/dev/null | grep -q "Battery"; then
        pmset -g batt | grep -Eo "\d+%"
    fi
    
    # Network
    if ping -c 1 -W 2 8.8.8.8 &>/dev/null; then
        echo "๐ Network: Online"
    else
        echo "๐ Network: Offline"
    fi
    
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
}

# ๐ Create Python project
create_project() {
    local name="${1:-myproject}"
    local stack="${2:-python}"
    
    mkdir -p "$name" && cd "$name" || return 1
    
    case $stack in
        python)
            python3 -m venv venv 2>/dev/null || true
            cat > main.py << 'PYTHON'
#!/usr/bin/env python3
print("๐ Project initialized successfully!")
PYTHON
            ;;
        node)
            npm init -y 2>/dev/null || true
            cat > index.js << 'NODE'
console.log('๐ Project initialized successfully!');
NODE
            ;;
    esac
    
    git init 2>/dev/null
    echo "โ Project '$name' created"
}

# ๐ค AI Chat (with error handling)
ai_chat() {
    local prompt="$*"
    [[ -z "$prompt" ]] && echo "Usage: ai_chat <prompt>" && return 1
    
    local api_key="${OPENAI_API_KEY:-$(cat ~/.openai_api_key 2>/dev/null)}"
    [[ -z "$api_key" ]] && echo "โ No OpenAI API key found" && return 1
    
    echo "๐ค Processing..."
    curl -s https://api.openai.com/v1/chat/completions \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer $api_key" \
        -d "{\"model\":\"gpt-3.5-turbo\",\"messages\":[{\"role\":\"user\",\"content\":\"$prompt\"}],\"temperature\":0.7}" \
        2>/dev/null | grep -o '"content":"[^"]*"' | head -1 | sed 's/"content":"//' | sed 's/"$//' || echo "โ API request failed"
}

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# SECTION 7: PRODUCTION DASHBOARD (FIXED - NO READ ERRORS)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

nexus_dashboard() {
    while true; do
        clear
        nexus_header
        
        cat << 'MENU'
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    NEXUSPRO DASHBOARD                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฃ
โ  1. ๐ฉบ  System Health         4. ๐ค  AI Chat                โ
โ  2. ๐ฆ  Create Project        5. ๐ง  Docker Setup           โ
โ  3. ๐จ  System Info           0. ๐ช  Exit                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
MENU
        
        printf "\nSelect option (0-5): "
        read -r choice
        
        case $choice in
            1) clear; system_health; printf "\nPress Enter..." && read -r ;;
            2) printf "Project name: " && read -r proj && create_project "$proj" ;;
            3) clear; echo "System: $(uname -s) $(uname -r)"; echo "CPU: $(sysctl -n machdep.cpu.brand_string 2>/dev/null)"; printf "\nPress Enter..." && read -r ;;
            4) printf "Prompt: " && read -r prompt && ai_chat "$prompt"; printf "\nPress Enter..." && read -r ;;
            5) echo "Setting up Docker..."; brew install docker docker-compose 2>/dev/null; echo "โ Done"; printf "\nPress Enter..." && read -r ;;
            0) echo "Goodbye!"; break ;;
            *) echo "Invalid option"; sleep 1 ;;
        esac
    done
}

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# SECTION 8: DOCKER FIX (For broken symlinks)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

docker_fix() {
    echo "๐ง Fixing Docker installation..."
    
    # Remove broken symlinks
    rm -f /usr/local/bin/docker 2>/dev/null || true
    rm -f /usr/local/bin/docker-compose 2>/dev/null || true
    
    # Reinstall via Homebrew
    if command -v brew &>/dev/null; then
        brew install docker docker-compose 2>/dev/null
        echo "โ Docker fixed"
    else
        echo "โ Homebrew not found"
    fi
}

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# SECTION 9: LOAD CUSTOM CONFIG
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

[[ -f ~/.zshrc_custom ]] && source ~/.zshrc_custom

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# SECTION 10: POWERLEVEL10K
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

[[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# END OF CONFIGURATION
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
